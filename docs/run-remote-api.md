# การรัน PLK Sync Server (API)

เอกสารอธิบายคำสั่งสำหรับการรัน Application `plk-sync-server` บนโปรดักชั่นเซิร์ฟเวอร์ด้วย `PM2` และ `uv` (Uvicorn)

## ตำแหน่งที่ตั้งไฟล์โปรเจกต์

```bash
cd ~/plk-sync-server
```

## คำสั่งสำหรับรัน/จัดการด้วย PM2

คำสั่งสำคัญที่ใช้จัดการ API ของเราบนเซิร์ฟเวอร์ผ่าน PM2:

### 1. ลบ Process ตัวเดิม (ถ้ามี)

หากต้องการแก้ไขการตั้งค่าหรือรีสตาร์ทด้วยคำสั่งใหม่ให้ลบตัวเดิมออกก่อน:

```bash
pm2 delete plk-sync-server
```

### 2. รัน API ขึ้นมาใหม่และกำหนด 4 Workers

เพื่อให้รองรับคำขอ (Requests) ได้มากขึ้น เราใช้ 4 workers สำหรับรัน Uvicorn แทนคำสั่งของ Python โดยตรง:

```bash
pm2 start "/home/adminplk/.local/bin/uv run uvicorn main:app --host 0.0.0.0 --port 8000 --workers 4" --name plk-sync-server
```

### 3. ตรวจสอบสถานะการทำงาน

ตรวจสอบว่า Process เริ่มทำงานและเปลี่ยนสถานะเป็น `online` แล้วหรือไม่:

```bash
pm2 list
# หรือ
pm2 status
```

### 4. บันทึก Process ไว้ให้เซิร์ฟเวอร์จำได้

เพื่อให้เวลาเซิร์ฟเวอร์โดนรีบูตใหม่ แล้วทำการรัน `plk-sync-server` แบบอัตโนมัติ ให้รัน:

```bash
pm2 save
```

### 5. วิธีตรวจสอบ Logs ของ API

รันคำสั่งด้านล่างเพื่อดูประวัติการเข้าใช้งานหรือเช็ก Errors ที่เกิดขึ้น:

```bash
pm2 logs plk-sync-server --lines 50
```

---

## ขั้นตอนการเช็กด้วยตัวเองหลังจากรันเสร็จ

เพื่อความชัวร์ สามารถทดสอบการเข้าถึงพอร์ตในเซิร์ฟเวอร์ด้วยคำสั่ง:

```bash
curl http://localhost:8000/health
```

**ควรจะได้รับผลลัพธ์เป็น:** `{"status":"ok"}`
